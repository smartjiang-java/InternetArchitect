
## 01:高并发,负载均衡,高可用
不要因为技术而技术  注意:位运算是计算机计算速度最快的
计算机是软件工程学,强调的是分层解耦 ,OSI分层参考模型

协议是什么?  
1:socket(套接字通信)  tcp建立通信,先从传输控制层开始向下,返回一个连接,才开始应用层
  套接字:localhost:8080   域名+端口号
2:传输数据(http协议:规范标准)

[在浏览器输入一个网址-->DNS解析--->通过TCP协议封装数据--->把TCP的报文封装成IP数据报--->通过ARP找到下一个要发送的机器,
封装成MAC地址--->缝装成帧发送]
每一层都有表 
用户态
[应用层:http,ssh协议  浏览器使用http协议,虚拟机使用ssh协议,发邮件smtp协议]

以下是内核态
[传输控制层:tcp udp :准备握手包 ] 
tcp面向连接(有确认),可靠的 三次握手(双方的输入和输出都保证),通知服务端开辟资源,默认开启一个端口号
四次挥手：一个操作系统的可用端口号为65535个，数量有限，四次分手是为了回收端口号
        1:用户端发送断开请求  2:服务端确认知道分手  3:服务端发送断开请求  4:用户端确认知道
        为什么? 双方都发送并确认,才能断开连接
三次握手--->数据传输-->四次挥手   这个过程称为一个最小粒度,不可被分割

[网络层:ip  路由表,自动生成(route -n) --下一跳机制,每一个互联网的设备只存储自己一步以内的设备 同一个局域网不需要下一条,不需要网关]
一般的网络会有[四个维度:
ip:独特的标识,是端口间的 192.168
掩码(常见255.255.255.0):与ip地址按位与,得出网络号,得到下一跳
网关:
dns域名解析地址:把域名给它,返回ip地址]

[链路层:mac地址(网卡地址 arp -a) ,下一跳给这个地址,每次寻找,改变的是MAC地址,mac是节点间的]
[目标设备的端口号:找到服务进程  目标设备ip地址:找到服务设备  mac地址:找到下一跳] 每次改变的是mac地址

[物理层:把两台计算机连接起来]



对外隐藏，对内可见：将 arp_igore设置为1，app_announce设置为2
现在os内核一般都带有lvs负载均衡模块，模块名称叫做ipvs   需要装一个软件ipvsadm，让这个模块和外界交互

[负载均衡动态负载算法]：
这个负载均衡器均有偷窥能力,当一个数据包(服务端域客户端第一次握手)来到负载均衡器的时候，窥视数据包的目标ip,并记录下来，知道数据包发给谁了;
第二次握手可能无法知道，但是第三次握手的时候，负载均衡器是可以再次偷窥到的，此时给服务器数量加1;断开原理也是如此。

实验手册：
VMware 提供虚拟网络net模式  虚拟的服务器主机  在windows中虚拟出来一块网卡

数据包包着数据包，常见的技术如VPN，翻墙
来的时候经过负载均衡，走的时候直接由服务端返回

一块物理网卡上可以有几个不同的地址

lo本地回环地址 ,这是虚拟网卡地址，内核知道有，外界不知道有，所以需要将目标地址配置到回环地址上。

逐层布置：
先配置网络层的vip,:三台虚拟机,一台做负载,另外两台做服务器
1:对于负载机的DIP已经好了,现在配置VIP    ifconfig eth0:2 192.168.150.100/24   注意/24代表255.255.255.0   /16代表255.255.0.0
如何让撤销  ifcinfig  eth0:2 down
2:对于另外的两台的服务器,需要先修改内核协议,防止通告,再去配置VIP(每台服务器均需要这样配置)
修改协议
cd /proc/sys/net/ipv4/conf/eth0
ll
echo 1 > arp_ignore  进行修改,使用vim无法修改
cat arp_ignore    确认
echo 2 > arp_announce
cat arp_announce
为了保证其他接口也生效,需要全局配置
cd ..
cd all
echo 1 > arp_ignore
echo 2 > arp_announce
配置VIP
ifconfig l0:2  192.168.150.100  netmask 255.255.255.255
注意:这个掩码为什么配置为255.255.255.255,而不是255.255.255.0  
防止地址与掩码与运算之后重复,两个地址都可以去,但是物理网卡与内核虚拟网卡比较,虚拟网卡更近,又因为环回接口又会把请求发送给自己,导致数据包发不出去
3:RS中的服务(服务机器)
yum install httpd -y  安装    
service httpd start    启动
vi   /var/www/html/index/html   创建一个主页    ,写入内容  from 192.168.150.12     注意:从浏览器访问192.168.150.13:80
4:配置ipvsadm软件和ipvs模块交互:负载机
yum install ipvsadm
ipvsadm -A -t 192.168.150.100:80  -s   rr  基于进来的数据包
ipvsadm -a -t 192.168.150.100:80  -r  192.168.1501.12(服务机地址) -g -w 1 将数据包负载
ipvsadm -ln 查看配置的规则
ipvsadm -a -t 192.168.150.100:80  -r  192.168.1501.13 -g -w 1  有几台服务器,就写几次
5:验证浏览器访问 192.168.150.100 看到负载,疯狂F5
  node -01
           netstat -natp  结论负载机看不到socket连接,服务机能看到socket连接
6:查看负载的头盔记录表
ipvsadm -lnc      state是FIN_WAIT是连接过,偷窥过所有的包   SYN_RECV:说明三次有问题,证明后面的网络层有问题,负载没问题









